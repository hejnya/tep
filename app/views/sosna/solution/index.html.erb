

<%#### seznam  ročníků -%>
<% if @annuals %>
 <h1>Řešení úloh po ročnících</h1>
   <% @annuals.each do |annual_no, annual| %>
    <ul class="breadcrumb">
      <li><%= link_to "Ročník #{annual_no}",  { roc: annual_no }  %><span class="divider">&gt;</span></li>
        <% annual.each do |round| %>
          <li><%= link_to round[:name],  round[:url]  %>
               <span class="divider">,</span></li>
        <% end %>
      </li>
    </ul>
   <% end %>
<% else %>

<%#### tabulka řešení -%>

<h1>Řešení úloh, ročník <%=@annual%>, série <%=@round%><%if @problem_no%>, úloha <%=@problem_no%><%end%></h1>

<% if @want_edit %>
  <%= form_tag action: :update_scores, :roc => @annual, :se => @round, :ul => @problem_no %> 
<% elsif @want_edit_paper %>
  <%= form_tag action: :update_papers, :roc => @annual, :se => @round, :ul => @problem_no %> 
<% elsif @want_edit_penalisation %>
  <%= form_tag action: :update_penalisations, :roc => @annual, :se => @round, :ul => @problem_no %> 
<% end %>


<table class="table table-bordered datatable">
  <thead>
  <tr>
   <th>Id</th>
   <th>Řešitel</th>
   <th>Škola</th>
  <% @problems.each do |pr| %>
   <th>u<%=pr.problem_no%></th>
  <% end %>
  <% @problems.each do |pr| %>
   <th title="Body za úlohu č. <%=pr.problem_no%>">B<%=pr.problem_no%></th>
  <% end %>
  <th title="penalizace">Pen<% if @want_edit_penalisation%> / Důvod<%end%></th>
  <th title="Výsledky">V</th>
 </tr>
 </thead>
 <tbody>
<% @solvers.each do |solver| %>
  <tr>
    <td><%= solver.id  %></td>
    <td><%= link_to solver.full_name, { controller: :solver, action: :show, id: solver.id }  %></td>
    <td><%= solver.school.nil? ? '-' : solver.school.short %></td>
    <% @problems.each do |pr| %>
       <% sol_arr = @solutions_by_solver[solver.id]  %>
       <% sol  =  sol_arr.nil?  ? nil : sol_arr[pr.problem_no]  %>
       <% ready = (!sol.filename.nil? && !sol.filename_corr.nil? || sol.has_paper_mail ) && !sol.score.nil? %>
       <% weird = (sol.filename.nil? && !sol.has_paper_mail ) && !sol.score.nil? %>
       <% weird = weird || (!sol.filename.nil? || sol.has_paper_mail ) && sol.score.nil? %>
       <% weird = weird || ( !sol.filename.nil? && sol.filename_corr.nil?  && !sol.score.nil? ) %>
       <% cls = weird ? 'bg-red' : (ready ? 'bg-green' : nil) %>
       <td<%if cls%> class="<%=cls%>"<%end%>>

         <% if @want_edit_paper %>
            <input type="checkbox" name="paper[<%= sol.id %>]" size="3" <%if sol.has_paper_mail %> checked="checked" <% end %> />
         <% else %>
           <% if sol.filename %>
             <%= link_to pr.problem_no, {:action => :download, :id => sol.id}, {:title => sol.filename_orig} %>
             <% if sol.filename_corr %>
               <%= link_to 'o', {:action => :download_rev, :id => sol.id}, {:title => sol.filename_corr_display} %>
             <% end %>
           <% end %>
           <% if sol.has_paper_mail %> P <% end %>
         <% end %>
       </td>
    <% end %>
    <%  @problems.each do |pr| %>
       <td>
         <% sol_arr = @solutions_by_solver[solver.id]  %>
         <% sol  =  sol_arr.nil?  ? nil : sol_arr[pr.problem_no]  %>
         <% if !sol.nil? %>
           <% if @want_edit %>
                <input class="input-mini input-minimini" type="text" name="score[<%= sol.id %>]" size="3" value="<%= sol.score || '-'%>"/>
           <% else %>
                <%= sol.score || '-'%>
           <% end %>
         <% else %>
          -
         <% end %>
       </td>
    <% end %>
    <td>
      <% pen = @penalisations_by_solver[solver.id] %>
      <% pen_sc = pen.score || '-' %>
      <% pen_tit = pen.title || '' %>
      <% if @want_edit_penalisation %>
        <input class="input-mini input-minimini" type="text" name="penalisation_score[<%= pen.id %>]" size="3" value="<%= pen_sc %>"/>
        <input class="input-medium" type="text" name="penalisation_title[<%= pen.id %>]" value="<%= pen_tit %>"/>
      <% else %>
        <span title="<%=pen_tit == '' ? 'žádný důvod' : pen_tit %>"><%= pen_sc  %></span>
      <% end %>
    </td>
    <td>
      <% res = @results_by_solver[solver.id] %>
      <% if res %>
          <%= res.score %>, <%= res.rank %>
      <% else %>
          -
      <% end %>
    </td>
  </tr>
<% end %>
 <tbody>
</table>
<a name='more'></a>
<% if @want_edit || @want_edit_paper || @want_edit_penalisation%>
<button type='submit' class='btn btn-danger'>Uložit</button> 
<%= link_to 'Zpět', {action: :index, roc: @annual, se: @round, ul: @problem_no}, {:class => 'btn'} %>

<div style='position:fixed;bottom:0px;left:0px;'>
<button type='submit' class='btn btn-danger'>Uložit</button> 
<%= link_to 'Zpět', {action: :index, roc: @annual, se: @round, ul: @problem_no}, {:class => 'btn'} %>
</div>

</form>

<% else %>

<div>
<i>Legenda</i>:
<b>P</b> -- řešení přislo papírově;
<b>1-9</b> řešení přišlo elektronicky, link na stažení;
<b>o</b> opravené řešení;
<span class='bg-green box'>&nbsp;</span> -- došlé řešení je obodované a pokud je elektronické, tak i nahrána oprava;
<span class='bg-red box'>&nbsp;</span> -- obodováná nedošlá úloha, nebo neobodována došlá úloha, nebo chybí el. oprava.
</div>

  <%= link_to 'Stáhnout tato řešení v jednom .zip',
            { :action => :downall, roc: @annual, se: @round, ul: @problem_no },
            { :class=> 'btn btn-primary'} %>

  <%= link_to 'Stáhnout opravena řešení v jednom .zip',
            { :action => :downall, roc: @annual, se: @round, ul: @problem_no, rev: 'yes' },
            { :class=> 'btn btn-primary'} %>

  <%= link_to 'Stáhnout tabulku řešitelů ve formátu CSV',
            { format: 'csv'},
            { :class=> 'btn btn-primary'} %>

  <%= link_to 'Stáhnout tabulku body.pik',
            { format: 'pik'},
            { :class=> 'btn btn-primary'} %>

  <%= form_tag({:action => :update_results, :roc => @annual, :se => @round, :ul => @problem_no}, :class => 'form-inline') do %>
          <%= submit_tag 'Vygenerovat výsledky', :class => 'btn btn-primary'  %>
  <% end %>

  <hr>
  <% if  @problem_no %>
    <a name="upload"></a>
    <div> Soubor ve tvaru <code>reseni-rocNN-seNN-ulNN-relNNN-ori-PRIMENI-JMENO.pdf</code>
    (tedy stejné jako neopravené řešení), nebo zip archiv s více opravenými řešeními
    (né nutně všemi):
    </div>
    <%= form_tag({:action => :upload_rev} , :multipart => true ) do %>
          <%= hidden_field_tag :roc, @annual %>
          <%= hidden_field_tag :se,  @round %>
          <%= hidden_field_tag :ul,  @problem_no %>
          <%= file_field_tag :file_rev, :class => 'input-small', :accept => '*.pdf|*.zip'  %>
          <%= submit_tag 'Nahraj opravené řešení (.pdf, .zip)',:class => 'btn'  %>
    <% end %>
    <hr>

  <% else %>
    Pro nahrání opraveného řešení vyber úlohu:
      <% @problems.each do |pr| %>
       <%= link_to "ul#{pr.problem_no}", { action: :index, roc: @annual, se: @round, ul: pr.problem_no , anchor: 'upload' } %>,
      <% end %>
  <% end %>
<% end %>


<% end # annuals %>
